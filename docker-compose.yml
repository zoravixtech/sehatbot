services:
  installer:
    image: node:22-alpine
    volumes:
      - .:/home/node/app
      - node_modules:/home/node/app/node_modules
    working_dir: /home/node/app
    command: sh -c "corepack enable && corepack prepare pnpm@latest --activate && pnpm install"

  server:
    image: node:22-alpine
    ports:
      - "8080:8080"
    volumes:
      - .:/home/node/app
      - node_modules:/home/node/app/node_modules
    working_dir: /home/node/app
    command: sh -c "corepack enable && corepack prepare pnpm@latest --activate && pnpm --filter @sehatbot/server dev"
    environment:
      - PORT=8080
      - GOOGLE_APPLICATION_CREDENTIALS=/home/node/app/gcp-key.json
    depends_on:
      installer:
        condition: service_completed_successfully

  client:
    image: node:22-alpine
    ports:
      - "5173:5173"
    volumes:
      - .:/home/node/app
      - node_modules:/home/node/app/node_modules
    working_dir: /home/node/app
    command: sh -c "corepack enable && corepack prepare pnpm@latest --activate && pnpm --filter @sehatbot/client dev --host"
    depends_on:
      installer:
        condition: service_completed_successfully

volumes:
  node_modules: